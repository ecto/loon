; testing.loon — Testing guide

[fn guide-testing-page []
  [doc-page "Testing" "Built-in test framework with effect-based mocking."

    [doc-section "The Test Form"
      [doc-text "Tests are defined with " [doc-code "test"] " directly in any module. No special framework needed."]
      [code-block {:label "LOON"} [str "[test \"addition works\" []\n" "  [assert-eq [+ 1 2] 3]]"]]
      [doc-text "Tests take a name, a parameter list (usually empty), and a body. No " [doc-code "fn"] " keyword."]]

    [doc-section "Assertions"
      [doc-text "Loon provides a small set of built-in assertion functions."]
      [doc-list
        [span [doc-code "assert-eq"] " — check two values are equal"]
        [span [doc-code "assert-ne"] " — check two values are not equal"]
        [span [doc-code "assert"] " — check a boolean is true"]
        [span [doc-code "assert-match"] " — check a value matches a pattern"]]
      [code-block {:label "LOON"} [str "[test \"assertions\" []\n" "  [assert-eq 4 [* 2 2]]\n" "  [assert-ne 3 4]\n" "  [assert [> 10 5]]\n" "  [assert-match [Some _] [Some 42]]]"]]
      [doc-note "tip" "assert-eq prints both values on failure, making debugging straightforward."]]

    [doc-section "Running Tests"
      [doc-text "Run all tests in a project with " [doc-code "loon test"] "."]
      [code-block {:label "SHELL"} [str "$ loon test\n" "running 12 tests\n" "  math.add .............. ok\n" "  math.subtract ......... ok\n" "  string.trim ........... FAIL\n" "\n" "11 passed, 1 failed"]]
      [doc-text "Filter tests by name with a pattern argument."]
      [code-block {:label "SHELL"} "$ loon test math"]
      [doc-note "info" "Tests run in parallel by default. Use --serial for tests that need ordering."]]

    [doc-section "Testing with Effects"
      [doc-text "Effects eliminate the need for mocking libraries. Wrap the code under test in a " [doc-code "handle"] " block with test-specific implementations."]
      [code-block {:label "LOON"} [str "[effect Http\n" "  [fn get [url]]]\n" "\n" "[fn fetch-title [url]\n" "  [let body [Http.get url]]\n" "  [parse-title body]]\n" "\n" "[test \"fetch-title parses html\" []\n" "  [let result\n" "    [handle [fetch-title \"http://example.com\"]\n" "      [Http.get url] => [resume \"<title>Hello</title>\"]]]\n" "  [assert-eq result \"Hello\"]]"]]
      [doc-text "The production handler makes real HTTP requests. The test handler returns canned data. Same function, different behavior."]
      [doc-note "tip" "This pattern works for databases, file systems, randomness — any effect."]]

    [doc-section "CI Integration"
      [doc-text "Use " [doc-code "loon test --format json"] " for machine-readable output in CI pipelines."]
      [code-block {:label "SHELL"} "$ loon test --format json > results.json"]
      [doc-text "The exit code is non-zero when any test fails, so standard CI tools work out of the box."]]

    [doc-prev-next "Macros" "/guide/macros" "Error Handling" "/guide/errors"]]]
